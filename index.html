<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Timesheet</title>
		<script type="text/javascript" src="./jquery_3_5_0.js"></script>
	
		<style>
			summary {
				cursor: pointer;
				font-size: 1.2em;
			}
		</style>

		<script type="text/javascript">

var g_text_area_ids_with_write_scheduled = new buckets.Set();

function initialize() {

	['#textarea_input'].forEach(function(textcompname) {
		$(textcompname).on('propertychange keyup input paste', function(){
			on_input_changed();
		});
	});
	on_input_changed();

	bind_text_control_to_localstorage('textarea_input');

	$('#textarea_input').scroll(function(){
		make_output_textareas_scroll_pos_match_input_textarea_scroll_pos();
	})

	make_tab_key_insert_tab_character_on_all_textareas();

	setInterval(update_output_textareas, 1000*10);
}

function get_date_from_hh_mm_str(hh_mm_str_) {
	let splits = hh_mm_str_.split(':', 2);
	let hours = parseInt(splits[0]);
	let minutes = parseInt(splits[1]);
	let r = new Date();
	r.setHours(hours);
	r.setMinutes(minutes);
	return r;
}

function make_output_textareas_scroll_pos_match_input_textarea_scroll_pos() {
	let pos = $('#textarea_input').scrollTop();
	$('#textarea_output_single_job_times').scrollTop(pos);
	$('#textarea_output_time_tally').scrollTop(pos);
	$('#textarea_output_time_of_day').scrollTop(pos);
}

function on_input_changed() {
	update_output_textareas();
	make_output_textareas_scroll_pos_match_input_textarea_scroll_pos();
}

function get_hh_mm_str(date_) {
	return sprintf("%02d:%02d\n", date_.getHours(), date_.getMinutes());
}

function update_output_textareas() {
	let all_lines = $('#textarea_input').val();
	let lines = all_lines.split(/\r?\n/);
	let total_num_hours = 0.0;
	let time_tally_str = '', single_job_times_str = '', time_of_day_str = '';
	let start_date = new Date();
	lines.forEach(function(line) {
		let set_time_of_day_match = line.match(/^time=.*?(\d\d+:\d\d|now)\s*$/);
		if(set_time_of_day_match != null) {
			let new_time_of_day_str = set_time_of_day_match[1];
			let time_of_day_date = new_time_of_day_str === "now" ? new Date() : get_date_from_hh_mm_str(new_time_of_day_str);
			start_date = time_of_day_date;
			total_num_hours = 0.0;
			single_job_times_str += "0:00\n";
			time_tally_str += "0:00\n";
			time_of_day_str += get_hh_mm_str(start_date);
		} else {
			let job_match = line.match(/^[^\s]+.*?(\d+:\d\d)\s*$/);
			if(job_match != null) {
				let num_hours_hh_mm_str = job_match[1];
				let num_hours_float = get_num_hours_float_from_HH_MM_str(num_hours_hh_mm_str);
				total_num_hours += num_hours_float;
				single_job_times_str += sprintf("%s\n", get_HH_MM_str_from_num_hours_float(num_hours_float));
				time_tally_str += sprintf("%s\n", get_HH_MM_str_from_num_hours_float(total_num_hours));
				time_of_day = new Date(start_date.getTime() + total_num_hours*60*60*1000);
				time_of_day_str += get_hh_mm_str(time_of_day);
			} else {
				single_job_times_str += "\n";
				time_tally_str += "\n";
				time_of_day_str += "\n";
			}
		}
	});
	single_job_times_str = single_job_times_str.slice(0, -1);
	time_tally_str = time_tally_str.slice(0, -1);
	time_of_day_str = time_of_day_str.slice(0, -1);
	$('#textarea_output_single_job_times').val(single_job_times_str);
	$('#textarea_output_time_tally').val(time_tally_str);
	$('#textarea_output_time_of_day').val(time_of_day_str);
}

function get_num_hours_float_from_HH_MM_str(hh_mm_str_) {
	let splits = hh_mm_str_.split(':', 2);
	let hours = parseInt(splits[0]);
	let minutes = parseInt(splits[1]);
	let r = hours + minutes/60.0;
	return r;
}

function get_HH_MM_str_from_num_hours_float(num_hours_float_) {
	let num_hours_int = Math.floor(num_hours_float_);
	let num_minutes = Math.round((num_hours_float_ - num_hours_int)*60);
	return sprintf("%d:%02d", num_hours_int, num_minutes);
}

function bind_text_control_to_localstorage(textarea_id_) {
	let storage_key = document.URL+' - textcontrol:'+textarea_id_;
	let stored_val = localStorage.getItem(storage_key);
	if(stored_val != null) {
		set_value(textarea_id_, stored_val);
	}
	$('#'+textarea_id_).bind('propertychange keyup input paste', function() {
		if(!g_text_area_ids_with_write_scheduled.contains(textarea_id_)) {
			let timer_func = function() {
				localStorage.setItem(storage_key, get_value(textarea_id_));
				g_text_area_ids_with_write_scheduled.remove(textarea_id_);
			};
			setTimeout(timer_func, 2000);
			g_text_area_ids_with_write_scheduled.add(textarea_id_);
		}
	});

	// The above write is supposed to catch all edits.  This one is a backup plan, in case that one has bugs: 
	setInterval(function() { localStorage.setItem(storage_key, get_value(textarea_id_)); }, 60*1000);
}

function bind_radio_buttons_to_localstorage(radiogroupname_) {
	var storage_key = document.URL+' - radiogroup:'+radiogroupname_;
	var stored_val = localStorage.getItem(storage_key);
	if(stored_val != null) {
		set_radio_val(radiogroupname_, stored_val);
	}
	$("input[type=radio][name='" + radiogroupname_ + "']").each(function() {
		$(this).click(function() { 
			localStorage.setItem(storage_key, radio_val(radiogroupname_));
		});
	});
}

function set_radio_val(groupname_, newval_) {
	$('input:radio[name='+groupname_+']').val([newval_]);
	var s = 'input[name='+groupname_+']:checked';
	$(s).click();
}

function get_value(textfieldname_) {
	return $("#"+textfieldname_).val();
}

function set_value(textfieldname_, value_) {
	return $("#"+textfieldname_).val(value_).trigger('input');
}

/* If we don't do this then the tab key switches to the next GUI control.  
Code thanks to https://stackoverflow.com/a/14166052 */
function make_tab_key_insert_tab_character_on_all_textareas() {
	let textareas = document.getElementsByTagName('textarea');
	let count = textareas.length;
	for(let i=0;i<count;i++){
			textareas[i].onkeydown = function(e){
					if(e.keyCode==9 || e.which==9){
							e.preventDefault();
							let s = this.selectionStart;
							this.value = this.value.substring(0,this.selectionStart) + "\t" + this.value.substring(this.selectionEnd);
							this.selectionEnd = s+1; 
					}
			}
	}
}

function radio_val(groupname_) {
	return $('input[name='+groupname_+']:checked').val();
}

$(document).ready(initialize);

		</script>
	</head>
	<body>
		<details>
			<summary>Instructions</summary>
			<textarea id="textarea_input_example" rows="33" cols="120" spellcheck="false" wrap="off" 
				style="background-image: linear-gradient(#F1F1F1 50%, #F9F9F9 50%); background-size: 100% 4rem;" readonly>
Example: 
(copy this and paste it into the text area below)

time=15:00
job #1  0:30
job #2  1:15
job #2  0:45

A "time=HH:MM" line sets (or resets) the start time.  You can use multiple 
"time=HH:MM" lines.  If you don't use any, the current time will be used as the 
start time - and this will be updated several times per minute.  "time=now" 
sets the start time to the current time - and this will also be updated several 
times per minute.

Any line that doesn't start with "time=" and starts with a non-space character 
and ends with HH:MM will be counted towards the time tally.  Therefore the line 
below will not be counted.  So adding an "x" is a convenient way of crossing 
off jobs:
job #4 0:30 x

You can add lines which contain numbers and they won't be counted towards the 
tally, as long as the line starts with a space or tab.  job #5   0:30
	- note: last time this took 0:40 

One way to show a reminder that you need to cross off, or show the start time 
for a job, is to specify a time of 0:00, as below: 

remember to drink water  0:00

dinner start time (target 18:30)  0:00

			</textarea>
		</details>
		<br>
		<br>
		<textarea rows="2" cols="120" spellcheck="false" style="background-size: 100% 4rem; resize: none;" readonly>Input:</textarea>
		<textarea rows="2" cols="10" spellcheck="false" style="background-size: 100% 4rem; resize: none;" readonly>Job time:</textarea>
		<textarea rows="2" cols="10" spellcheck="false" style="background-size: 100% 4rem; resize: none;" readonly>Job time tally:</textarea>
		<textarea rows="2" cols="10" spellcheck="false" style="background-size: 100% 4rem; resize: none;" readonly>Time of day finished:</textarea>
		<textarea id="textarea_input" rows="600" cols="120" spellcheck="false" wrap="off" 
			style="background-image: linear-gradient(#F1F1F1 50%, #F9F9F9 50%); background-size: 100% 4rem;"></textarea>
		<textarea id="textarea_output_single_job_times" rows="600" cols="10" spellcheck="false" readonly 
			style="background-image: linear-gradient(#F1F1F1 50%, #F9F9F9 50%); background-size: 100% 4rem;"></textarea>
		<textarea id="textarea_output_time_tally" rows="600" cols="10" spellcheck="false" readonly 
			style="background-image: linear-gradient(#F1F1F1 50%, #F9F9F9 50%); background-size: 100% 4rem;"></textarea>
		<textarea id="textarea_output_time_of_day" rows="600" cols="10" spellcheck="false" readonly 
			style="background-image: linear-gradient(#F1F1F1 50%, #F9F9F9 50%); background-size: 100% 4rem;"></textarea>
	</body>
</html>
